name: "Build Password Generator Pro"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-binaries:
    name: "Build binaries"
    strategy:
      fail-fast: false
      matrix:
        rust_version: [stable]
        platform:
          # Windows
          - { id: windows, target: x86_64-pc-windows-msvc, os: windows-latest }
          - { id: windows, target: x86_64-linux-musl-gcc, os: windows-latest }
          - { id: windows, target: aarch64-pc-windows-msvc, os: windows-latest }

          # Ubuntu with default features
          - { id: ubuntu, target: aarch64-unknown-linux-gnu, os: ubuntu-latest }
          - { id: ubuntu, target: x86_64-unknown-linux-gnu, os: ubuntu-latest }

          # macOS
          - { id: macos, target: x86_64-apple-darwin, os: macos-latest }
          - { id: macos, target: aarch64-apple-darwin, os: macos-latest }

    env:
      APP_VERSION: "0.0.1"
      RUST_BACKTRACE: 1
      CARGO_INCREMENTAL: 0
      RUSTFLAGS: "-C debuginfo=0"
      OPTIONS: ${{ matrix.platform.options }}
      FEATURES: ${{ format(',{0}', matrix.platform.features ) }}
      CMD: ${{ matrix.platform.cmd }}

    runs-on: ${{ matrix.platform.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          target: ${{ matrix.platform.target }}
          toolchain: ${{ matrix.rust_version }}

      # - name: Install aarch64-apple-darwin Rust target
      #   if: matrix.os == 'macos-latest'
      #   run: rustup target add aarch64-apple-darwin

      # - name: Install x86_64-apple-darwin Rust target
      #   if: matrix.os == 'macos-latest'
      #   run: rustup target add x86_64-apple-darwin

      # - name: Install x86_64-linux-musl-gcc Rust target
      #   if: matrix.os == 'windows-latest'
      #   run: rustup target add x86_64-linux-musl-gcc

      # - name: Install x86_64-unknown-linux-musl Rust target
      #   if: matrix.os == 'ubuntu-latest'
      #   run: rustup target add x86_64-unknown-linux-musl

      # - name: Install aarch64-unknown-linux-musl Rust target
      #   if: matrix.os == 'ubuntu-latest'
      #   run: rustup target add aarch64-unknown-linux-musl

      # - name: Install x86_64-unknown-linux-gnu Rust target
      #   if: matrix.os == 'ubuntu-latest'
      #   run: rustup target add x86_64-unknown-linux-gnu

      # - name: Install x86_64-pc-windows-msvc Rust target
      #   if: matrix.os == 'windows-latest'
      #   run: rustup target add x86_64-pc-windows-msvc

      # - name: Install aarch64-pc-windows-msvc Rust target
      #   if: matrix.os == 'windows-latest'
      #   run: |
      #     # Disable the download progress bar which can cause perf issues
      #     $ProgressPreference = "SilentlyContinue"
      #     Invoke-WebRequest https://win.rustup.rs/ -OutFile rustup-init.exe
      #     .\rustup-init.exe -y --default-host=x86_64-pc-windows-msvc --default-toolchain=none
      #     del rustup-init.exe
      #     rustup target add aarch64-pc-windows-msvc
      #     shell: powershell

      - name: Install aarch64-unknown-linux-gnu Rust target
        if: matrix.platform.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get install -qy binutils-aarch64-linux-gnu gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          export CMAKE_SYSTEM_NAME=Linux
          export TARGET=aarch64-linux-gnu
          export TARGET_AR=aarch64-linux-gnu-ar
          export TARGET_CC=aarch64-linux-gnu-gcc
          export TARGET_CXX=aarch64-linux-gnu-g++
          export TARGET_RANLIB=aarch64-linux-gnu-ranlib
          export TARGET_CPP=aarch64-linux-gnu-cpp
          export TARGET_LD=aarch64-linux-gnu-ld
          export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=$TARGET_CC

      - name: Install musl tools
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get install -y musl-tools

      - name: Release build
        uses: actions-rs/cargo@v1

      - name: Cache cargo folder
        uses: actions/cache@v2
        with:
          path: ~/.cargo
          key: ${{ matrix.platform.target }}-${{ env.APP_VERSION }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Rust stable
        uses: actions-rs/toolchain@v1
        with:
          target: ${{ matrix.platform.target }}
          toolchain: ${{ matrix.rust_version }}

      - name: Install Gtk (ubuntu only)
        if: matrix.platform.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            curl \
            libasound2-dev \
            libayatana-appindicator3-dev \
            libgtk-3-dev \
            librsvg2-dev \
            libsoup2.4-dev \
            libssl-dev \
            libwebkit2gtk-4.0-dev \
            wget \

      - name: Install GCC Multilib
        if: (matrix.platform.os == 'ubuntu-latest') && contains(matrix.platform.target, 'i686')
        run: sudo apt-get install gcc-multilib

      - name: Install cargo-apk
        if: contains(matrix.platform.target, 'android')
        run: cargo install cargo-apk

      - name: Build
        shell: bash
        run: cd src-tauri/ && cargo $CMD build --verbose --target ${{ matrix.platform.target }} $OPTIONS --features $FEATURES --release

      - name: Rename binary (windows)
        if: contains(matrix.platform.target, 'windows')
        run: mv src-tauri/target/${{ matrix.platform.target }}/release/password-generator-pro.exe src-tauri/target/${{ matrix.platform.target }}/release/password-generator-pro-${{ matrix.platform.id }}.exe

      - name: Rename binary (macos)
        if: contains(matrix.platform.target, 'darwin')
        run: mv src-tauri/target/${{ matrix.platform.target }}/release/password-generator-pro src-tauri/target/${{ matrix.platform.target }}/release/password-generator-pro-${{ matrix.platform.id }}

      - name: Rename binary (linux)
        if: contains(matrix.platform.target, 'linux')
        run: mv src-tauri/target/${{ matrix.platform.target }}/release/password-generator-pro src-tauri/target/${{ matrix.platform.target }}/release/password-generator-pro-${{ matrix.platform.id }}

      # - name: Install pNpM
      #   uses: pnpm/action-setup@v2.2.4
      #   with:
      #     version: 7

      # - name: Use Node.js ${{ matrix.node-version }}
      #   uses: actions/setup-node@v2
      #   with:
      #     node-version: ${{ matrix.node-version }}
      #     cache: "pnpm"

      # - name: Install pNpM dependencies
      #   run: pnpm install --frozen-lockfile

      # - name: Install Rust
      #   uses: actions-rs/toolchain@v1
      #   with:
      #     toolchain: stable
      #     profile: minimal
      #     override: true

      # - name: Rust Cache
      #   uses: Swatinem/rust-cache@v2
      #   with:
      #     workspaces: src-tauri

      # # https://tauri.app/v1/guides/getting-started/prerequisites/
      # - name: Install dependencies (Linux)
      #   if: runner.os == 'Linux'
      #   run: |
      #     sudo apt update
      #     sudo apt install -y libwebkit2gtk-4.0-dev \
      #         build-essential \
      #         curl \
      #         wget \
      #         libasound2-dev \
      #         libssl-dev \
      #         libgtk-3-dev \
      #         libayatana-appindicator3-dev \
      #         librsvg2-dev

      # - name: Add Rust build targets (Windows)
      #   if: runner.os == 'Windows'
      #   run: |
      #     rustup target add aarch64-pc-windows-msvc
      #     rustup target add i686-pc-windows-msvc
      #     rustup target add x86_64-pc-windows-msvc

      # - name: Add Rust build targets (Linux)
      #   if: runner.os == 'Linux'
      #   run: |
      #     rustup target add x86_64-unknown-linux-gnu
      # - name: Add Rust build targets (macOS)
      #   if: runner.os == 'macOS'
      #   run: |
      #     rustup target add aarch64-apple-darwin
      #     rustup target add x86_64-apple-darwin

      # - name: Cache Cargo dependencies
      #   id: cargo-cache
      #   uses: actions/cache@v3
      #   with:
      #     path: |
      #       ~/.cargo/bin/
      #       ~/.cargo/registry/index/
      #       ~/.cargo/registry/cache/
      #       ~/.cargo/git/db/
      #       src-tauri/target/
      #     key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      # - name: Install app dependencies and build it
      #   run: pnpm run build

      # - name: Build
      #   run: cd src-tauri && cargo build --verbose

      # - name: Run tests
      #   run: cd src-tauri && cargo test --verbose

      # - name: Tauri build
      #   uses: tauri-apps/tauri-action@v0
      #   # enable cache even though failed
      #   # continue-on-error: true
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
      #     TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
      #   with:
      #     tagName: v__VERSION__
      #     releaseName: "Password Generator Pro v__VERSION__"
      #     releaseBody: "More new features are now supported."
      #     releaseDraft: true
      #     prerelease: false

      # - name: Upload dist (Windows, Setup)
      #   if: runner.os == 'Windows'
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: win32-setup
      #     path: "out/*-setup-*.exe"

      # - name: Upload dist (Windows, MSI)
      #   if: runner.os == 'Windows'
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: win32-msi
      #     path: "out/*-setup-msi-*.msi"

      # - name: Upload dist (Windows, Standalone)
      #   if: runner.os == 'Windows'
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: win32-standalone
      #     path: "out/*-standalone-*.exe"

      # - name: Upload dist (Linux, Deb)
      #   if: runner.os == 'Linux'
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: linux-deb
      #     path: "out/*.deb"

      # - name: Upload dist (Linux, AppImage)
      #   if: runner.os == 'Linux'
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: linux-appimage
      #     path: "out/*.AppImage"

      # - name: Upload dist (macOS)
      #   if: runner.os == 'macOS'
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: macos-dmg
      #     path: "out/*.dmg"

      # - name: Upload dist (macOS, Standalone)
      #   if: runner.os == 'macOS'
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: macos-standalone
      #     path: "out/*-standalone-*.zip"
