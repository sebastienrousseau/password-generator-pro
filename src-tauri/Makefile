# Password Generator Pro Makefile
# Maintainer: Sebastien Rousseau
# License: See LICENSE-APACHE and LICENSE-MIT files for details.

#  SYNOPSIS
#
#    make <target> [flags...]
#
#  TARGETS
#    bloat             		Evaluating resource allocation of the project
#    build             		Building the project
#    build-all         		Building all the binaries
#    build-linux       		Generating Linux binary
#    build-macos       		Generating MacOS binary
#    build-release     		Build the project in release mode
#    build-windows     		Generating Windows binary
#    clean             		Clean the project
#    fix               		Fix code
#	 help              		Show this help
#    install-pkgs      		Install required packages
#    lint              		Lint code
#    move-assets       		Move assets
#	 icon			  		Generate icon
#    package-windows   		Package Windows binary
#    package-macos     		Package macOS binary
#    package-linux-arm64 	Package Linux ARM64 binary
#    package-linux-amd64 	Package Linux AMD64 binary
#    package-linux-i686  	Package Linux I686 binary
#    rebuild           		Rebuild the project
#    release           		Build the project in release mode
#    remove-all-builds 		Remove all builds
#    run-linux         		Run Linux binary
#    run-macos         		Run macOS binary
#    run-windows       		Run Windows binary
#    security          		Security checks
#    test              		Run tests
#    udeps			 		Find unused dependencies
#    valgrind          		Run Valgrind
#
#
#  FLAGS
#    BLOATARGS         		Arguments to pass to cargo bloat
#    BUILD_DIR         		Build directory
#    RUST_PKGS         		Rust packages to install
#    TESTARGS          		Arguments to pass to cargo test
#    TESTARGS_LINUX    		Arguments to pass to cargo test on Linux
#    TESTARGS_MACOS    		Arguments to pass to cargo test on macOS
#    TESTARGS_WINDOWS  		Arguments to pass to cargo test on Windows
#    UPDATEARGS        		Arguments to pass to cargo update
#    UPDATEARGS_LINUX  		Arguments to pass to cargo update on Linux
#    UPDATEARGS_MACOS  		Arguments to pass to cargo update on macOS
#    UPDATEARGS_WINDOWS 	Arguments to pass to cargo update on Windows
#

include Makefile.config.in
include Makefile.log.in

# Evaluating resource allocation of the project
bloat:
	$(call log,Evaluating resource allocation of ${PROJECT} ü§î)
	@$(CARGO) make --makefile Makefile.toml bloat ${BLOATARGS}
	$(call log, Completed evaluating resource allocation of ${PROJECT} ‚úÖ)

# Building the project
build:
	$(call log,Compiling ${PROJECT} and all of its dependencies üë∑‚Äç‚ôÄÔ∏è)
	@$(CARGO) make --makefile Makefile.toml build
	$(call log, Build is done ‚úÖ)

# Building all the binaries
build-all:
	$(call log,Compiling ${PROJECT} for all the platforms and their dependencies üë∑‚Äç‚ôÄÔ∏è)
	@make build-macos
	$(call log, MacOS binary is built 	‚úÖ)
	@make build-linux
	$(call log, Linux binary is built 	‚úÖ)
	@make build-windows
	$(call log, Windows binary is built ‚úÖ)
	$(call log, All ${PROJECT} binaries for macOS, Linux and Windows are built ‚úÖ)

# Generating Linux binary
build-linux:
	$(call log,Generating ${PROJECT} Linux binary üêß)
	@rustup target add $(LINUX_TARGET)
	@$(CARGO) make --makefile Makefile.toml build-linux
	@make move-assets BUILD_DIR=target/linux/$(LINUX_TARGET)/release/assets
	$(call log, Linux binary is built 	‚úÖ)
	$(call log, Run ${GREEN}make run-linux${NC}to run the binary!")

# Generating MacOS binary
build-macos:
	$(call log,Generating ${PROJECT} MacOS binary üçé)
	@rustup target add $(MACOS_TARGET)
	@$(CARGO) make --makefile Makefile.toml build-macos
	@make move-assets BUILD_DIR=target/macos/$(MACOS_TARGET)/release/assets
	$(call log, MacOs binary is built 	‚úÖ)
	$(call log, Run ${GREEN}make run-macos${NC}to run the binary!")

# Build the project in release mode
build-release:
	$(call log,Building ${PROJECT} in release mode)
	@$(CARGO) build-release
	$(call log, Build-release is done 	‚úÖ)

# Generating Windows binary
build-windows:
	$(call log,Generating ${PROJECT} Windows binary ü™ü)
	@rustup target add $(WINDOWS_TARGET)
	@$(CARGO) make --makefile Makefile.toml build-windows
	@make move-assets BUILD_DIR=target/windows/$(WINDOWS_TARGET)/release/assets
	$(call log, Windows binary is built ‚úÖ)
	$(call log, Run ${GREEN}make run-windows${NC}to run the binary!")

# Clean the project
clean:
	$(call log,Cleaning ${PROJECT} üßΩ)
	@$(CARGO) clean
	$(call log, Clean is done ‚úÖ)

# Fix code
fix:  ## Fix code üõ†
	$(call log,Fixing ${PROJECT} üõ†)
	@$(CARGO) fix --allow-dirty || cargo fix --allow-staged
	$(call log, Fix is done ‚úÖ)

# Install required packages
install-pkgs:
	$(call log,Installing ${RUST_PKGS})
	@rustup component add clippy
	$(call log, Clippy is installed ‚úÖ)
	@rustup component add rustfmt
	$(call log, Rustfmt is installed ‚úÖ)
	@$(CARGO) install cargo-make
	$(call log, Cargo-make is installed ‚úÖ)
	@$(CARGO) install cargo-audit
	$(call log, Cargo-audit is installed ‚úÖ)
	@$(CARGO) install cargo-bloat
	$(call log, Cargo-bloat is installed ‚úÖ)
	@$(CARGO) install cargo-udeps
	$(call log, Cargo-udeps is installed ‚úÖ)
	@$(CARGO) install cargo-valgrind
	$(call log, Cargo-valgrind is installed ‚úÖ)

# Lint code
lint:
	$(call log,Checks a package to catch common mistakes and improve ${PROJECT} üßπ)
	@$(CARGO) clippy --all-targets --all-features -- -D warnings
	$(call log, Lint is done ‚úÖ)

# Move assets
move-assets:
	$(call log,Moving assets üî•)
	@cp -R $(ASSETS_DIR) $(BUILD_DIR)
	$(call log, Assets are moved ‚úÖ)

# Icon generation
icon:
	$(call log,Generating icon üé®)
	@cargo tauri icon assets/icon.png
	$(call log, Icon is generated ‚úÖ)

# Package windows binaries (i686-pc-windows-msvc, x86_64-pc-windows-msvc)
package-windows:
	$(call log,Generating Windows binaries ü™ü)
	@rustup target add i686-pc-windows-msvc
	$(call log, i686-pc-windows-msvc is added ‚úÖ)
	@rustup target add x86_64-pc-windows-msvc
	$(call log, x86_64-pc-windows-msvc is added ‚úÖ)
	@cargo tauri build --target i686-pc-windows-msvc
	$(call log, i686-pc-windows-msvc is built ‚úÖ)
	@cargo tauri build --target x86_64-pc-windows-msvc
	$(call log, x86_64-pc-windows-msvc is built ‚úÖ)

# Package macos binaries (aarch64-apple-darwin, x86_64-apple-darwin)
package-macos:
	$(call log,Generating MacOS binaries üçé)
	@rustup target add aarch64-apple-darwin
	$(call log, aarch64-apple-darwin is added ‚úÖ)
	@rustup target add x86_64-apple-darwin
	$(call log, x86_64-apple-darwin is added ‚úÖ)
	@cargo-tauri build --target aarch64-apple-darwin
	$(call log, aarch64-apple-darwin is built ‚úÖ)
	@cargo-tauri build --target x86_64-apple-darwin
	$(call log, x86_64-apple-darwin is built ‚úÖ)
	@chmod +x /Users/runner/work/syng/syng/src/native/target/x86_64-apple-darwin/release/bundle/macos/Syng.app/Contents/MacOS/Syng
	$(call log, x86_64-apple-darwin is made executable ‚úÖ)
	@chmod +x /Users/runner/work/syng/syng/src/native/target/aarch64-apple-darwin/release/bundle/macos/Syng.app/Contents/MacOS/Syng
	$(call log, aarch64-apple-darwin is made executable ‚úÖ)

# Package linux arm64 binaries (aarch64-unknown-linux-gnu)
package-linux-arm64:
	$(call log,Packaging Linux arm64 binaries üêß)
	@rustup target add aarch64-unknown-linux-gnu
	$(call log, aarch64-unknown-linux-gnu is added ‚úÖ)
	@cargo tauri build --target aarch64-unknown-linux-gnu
	$(call log, aarch64-unknown-linux-gnu is built ‚úÖ)

# Package linux amd64 binaries (x86_64-unknown-linux-gnu)
package-linux-amd64:
	$(call log,Packaging Linux x86_64 binaries üêß)
	@rustup target add x86_64-unknown-linux-gnu
	$(call log, x86_64-unknown-linux-gnu is added ‚úÖ)
	@cargo tauri build --target x86_64-unknown-linux-gnu
	$(call log, x86_64-unknown-linux-gnu is built ‚úÖ)

# Package linux i686 binaries
package-linux-i686:
	$(call log,Packaging Linux i686 binaries üêß)
	@rustup target add i686-unknown-linux-gnu
	$(call log, i686-unknown-linux-gnu is added ‚úÖ)
	@cargo tauri build --target i686-unknown-linux-gnu
	$(call log, i686-unknown-linux-gnu is built ‚úÖ)

# Rebuild the project
rebuild:
	$(call log,Rebuilding ${PROJECT} üöÄ)
	@$(CARGO) rebuild
	$(call log, Rebuild is done ‚úÖ)

# Build the project in release mode
release:
	$(call log,Building ${PROJECT} in release mode üöÄ)
	@$(CARGO) build --release
	$(call log, Release build is done ‚úÖ)

# Remove all builds
remove-all-builds:
	$(call log,Removing all builds üßπ)
	rm -rf target
	$(call log, All builds are removed ‚úÖ)

# Run Linux binary
run-linux:
	$(call log,Running Linux binary üêß)
	./target/linux/x86_64-unknown-linux-musl/release/password-generator-pro
	$(call log, Running Linux binary! ‚úÖ)

# Run macOS binary
run-macos:
	$(call log,Running MacOS binary üçé)
	./target/macos/aarch64-apple-darwin/release/password-generator-pro
	$(call log, Running MacOS binary! ‚úÖ)

# Run Windows binary
run-windows:
	$(call log,Running Windows binary ü™ü)
	./target/windows/x86_64-pc-windows-gnu/release/password-generator-pro.exe
	$(call log, Running Windows binary! ‚úÖ)

# Check code for security issues
security:
	$(call log,Checking security of ${PROJECT} üîê)
	@$(CARGO) security
	$(call log, Security check is done ‚úÖ)

# Run tests
test:
	$(call log,Testing ${PROJECT} üß™)
	@$(CARGO) test
	$(call log, Tests are done ‚úÖ)

# Check unused dependencies
udeps:
	$(call log,Checking unused dependencies for ${PROJECT} üì¶)
	@$(CARGO) udeps
	$(call log, Unused dependencies check is done ‚úÖ)

# Check memory leaks
valgrind:
	$(call log,Checking memory leaks for ${PROJECT} üß†)
	@$(CARGO) valgrind
	$(call log, Memory leaks check is done ‚úÖ)

# Display the help menu
help:
	@echo "\n$$(tput bold)Welcome to Password Generator Pro!$$(tput sgr0)\nFast, Simple And Secure Password Generator$$(tput sgr0)\n"
	@ echo '  Usage:'
	@ echo ''
	@ echo '    make <target> [flags...]'
	@ echo ''
	@ echo '  Targets:'
	@ echo ''
	@ awk '/^#/{ comment = substr($$0,3) } comment && /^[a-zA-Z][a-zA-Z0-9_-]+ ?:/{ print "   ", $$1, comment }' $(MAKEFILE_LIST) | column -t -s ':' | sort
	@ echo ''
	@ echo '  Flags:'
	@ echo ''
	@ echo '    BLOATARGS 		Arguments to pass to cargo bloat'
	@ echo '    BUILD_DIR 		Directory to build the project'
	@ echo '    PROJECT 		Name of the project'
	@ echo '    RUST_PKGS 		Rust packages to install'
	@ echo '    ASSETS_DIR 		Directory containing assets'
	@ echo '    LINUX_TARGET 	Target for Linux'
	@ echo '    MACOS_TARGET 	Target for MacOS'
	@ echo '    WINDOWS_TARGET 	Target for Windows'
	@ echo ''


.PHONY: bloat build build-all build-linux build-macos build-release build-windows clean fix help install-pkgs lint move-assets package-macos rebuild release remove-all-builds run-linux run-macos run-windows security test udeps valgrind